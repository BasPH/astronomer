#!/bin/sh

for component in ${COMPONENTS} ; do
    echo "Building ${component}..."

    DOCKER_FILE="alpine/${component}/Dockerfile"
    COMPONENT_NAME="ap-${component}"

    if [ -f "${DOCKER_FILE}" ]; then
        docker build --build-arg BUILD_NUMBER=${BUILD_NUMBER} -t ${REPOSITORY}/${COMPONENT_NAME}:latest -f ${DOCKER_FILE} alpine/${component} || exit 1
        docker tag ${REPOSITORY}/${COMPONENT_NAME}:latest ${REPOSITORY}/${COMPONENT_NAME}:${ASTRONOMER_VERSION}
    fi
    if [ -f "${DOCKER_FILE}.onbuild" ]; then
        docker build --build-arg BUILD_NUMBER=${BUILD_NUMBER} -t "${REPOSITORY}/${COMPONENT_NAME}:latest-onbuild" -f "${DOCKER_FILE}.onbuild" alpine/${component} || exit 1
        docker tag ${REPOSITORY}/${COMPONENT_NAME}:latest-onbuild ${REPOSITORY}/${COMPONENT_NAME}:${ASTRONOMER_VERSION}-onbuild
    fi
done
